# 
version: 2.1

orbs:
  aws-cli: circleci/aws-cli@5.1.1

jobs:
  test-oidc:
    docker:
      - image: cimg/base:stable  # lightweight; includes curl, jq, etc.
    steps:
      - run:
          name: üõ†Ô∏è Token sanity check
          command: |
            echo "üîç Checking for CircleCI OIDC token..."
            echo "$CIRCLE_OIDC_TOKEN" | cut -d "." -f2 | base64 -d | jq .
            echo "üîç Decoding token claims..."
            echo "$CIRCLE_OIDC_TOKEN" \
              | awk -F. '{print $2}' \
              | base64 -d 2>/dev/null \
              | jq '{iss, aud, sub}'
      - run:
          name: üîç Decode CircleCI OIDC Token
          command: |
            echo "üîç Checking for CircleCI OIDC token..."
            if [ -n "$CIRCLE_OIDC_TOKEN_V2" ]; then
              TOKEN="$CIRCLE_OIDC_TOKEN_V2"
            elif [ -n "$CIRCLE_OIDC_TOKEN_FILE" ]; then
              TOKEN=$(cat "$CIRCLE_OIDC_TOKEN_FILE")
            else
              echo "‚ùå No OIDC token found."
              exit 1
            fi
      - aws-cli/setup:
          role_arn: "arn:aws:iam::056198491146:role/CircleCIInfraRole"
          role_session_name: "circleci-oidc-test"
          region: "ap-southeast-1"
          profile_name: "oidc-test"
          session_duration: "3600"

      - run:
          name: üß† Verify AWS Identity
          command: |
            echo "üîç Calling STS get-caller-identity..."
            aws sts get-caller-identity --profile oidc-test || {
              echo "‚ùå Failed to assume role."
              exit 1
            }

workflows:
  verify-oidc:
    jobs:
      - test-oidc