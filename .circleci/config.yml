version: 2.1

orbs:
  aws-cli: circleci/aws-cli@5.1.1
  python: circleci/python@2.1.1

jobs:
  # 🚀 Universal CDK Deploy Job
  deploy:
    docker:
      - image: cimg/python:3.11-node
    parameters:
      env:
        type: string
        default: "dev"
    steps:
      - checkout

      # 🧰 AWS OIDC role assumption
      - aws-cli/setup:
          role_arn: "arn:aws:iam::056198491146:role/CircleCIInfraRole"
          role_session_name: "circleci-deploy-<< parameters.env >>"
          region: "ap-southeast-1"

      # ⚡ Restore cached npm + CDK CLI
      - restore_cache:
          keys:
            - v1-cdk-cli

      # 🧰 Install AWS CDK CLI (user-space, no root permission)
      - run:
          name: 🧰 Install AWS CDK CLI
          command: |
            mkdir -p ~/.local/bin
            npm install aws-cdk@2 --prefix ~/.local
            ~/.local/bin/cdk --version

      # 💾 Save cache to speed up next run
      - save_cache:
          key: v1-cdk-cli
          paths:
            - ~/.npm
            - ~/.local/lib/node_modules

      # 🐍 Setup Python + venv
      - run:
          name: 🐍 Setup Python & install CDK dependencies
          command: |
            cd cdk
            python -m venv .venv
            . .venv/bin/activate
            pip install -r requirements.txt

      # 🚀 Deploy CDK stack with dynamic env
      - run:
          name: 🚀 Deploy CDK stack (<< parameters.env >>)
          command: |
            cd cdk
            . .venv/bin/activate
            ~/.local/bin/cdk bootstrap aws://$AWS_ACCOUNT_ID/$AWS_REGION
            ~/.local/bin/cdk deploy --require-approval never -c env=<< parameters.env >>


workflows:
  deploy_pipeline:
    jobs:
      - deploy:
          name: deploy-dev
          env: dev
      - hold-for-approval:
          type: approval
          requires:
            - deploy-dev
      - deploy:
          name: deploy-prod
          env: prod
          requires:
            - hold-for-approval
