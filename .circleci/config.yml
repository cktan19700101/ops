version: 2.1

orbs:
  oidc-token: circleci/oidc-token@1
  aws-cli: circleci/aws-cli@5.1.1

jobs:
  test-oidc:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout

      # Step 1: fetch a token using the official orb
      - oidc-token/get:
          audience: "https://aws.amazon.com"
          output-variable-name: CIRCLE_OIDC_TOKEN

      # Step 2: decode and inspect it
      - run:
          name: ðŸ” Decode OIDC token
          command: |
            echo "ðŸ” Decoding OIDC token..."
            echo "$CIRCLE_OIDC_TOKEN" | awk -F. '{print $2}' | base64 -d 2>/dev/null | jq '{iss,aud,sub}'
            echo "â€”â€” full payload â€”â€”"
            echo "$CIRCLE_OIDC_TOKEN" | awk -F. '{print $2}' | base64 -d 2>/dev/null | jq .

      # Step 3: optional manual AWS test
      - run:
          name: âš™ï¸ Manual STS AssumeRoleWithWebIdentity
          command: |
            echo "$CIRCLE_OIDC_TOKEN" > token.jwt
            aws sts assume-role-with-web-identity \
              --role-arn arn:aws:iam::056198491146:role/CircleCIInfraRole \
              --role-session-name circleci-oidc-test \
              --web-identity-token file://token.jwt \
              --region ap-southeast-1

workflows:
  verify-oidc:
    jobs:
      - test-oidc:
          context: my-oidc-enabled-context   # ðŸ‘ˆ ensure this context has OIDC enabled
