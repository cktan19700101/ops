version: 2.1

orbs:
  python: circleci/python@2.1.1
  aws-cli: circleci/aws-cli@3.1.5

jobs:
  deploy:
    docker:
      - image: cimg/python:3.11
    parameters:
      env_name:
        type: string
    steps:
      - checkout

      # ‚úÖ Setup AWS credentials via OIDC
      - aws-cli/setup:
          role-arn: arn:aws:iam::${AWS_ACCOUNT_ID}:role/CircleCIInfraRole
          aws-region: ap-southeast-1

      # üêç Setup Python & install dependencies
      - run:
          name: Setup Python & install CDK
          command: |
            cd cdk
            python -m venv .venv
            . .venv/bin/activate
            pip install -r requirements.txt
            pip install aws-cdk-lib constructs

      # üöÄ Deploy Stack
      - run:
          name: Bootstrap & deploy stack
          command: |
            cd cdk
            . .venv/bin/activate
            cdk bootstrap aws://$AWS_ACCOUNT_ID/$AWS_REGION
            cdk deploy \
              -c env=<< parameters.env_name >> \
              -c main_bucket_name=$MAIN_BUCKET_NAME \
              -c log_bucket_name=$LOG_BUCKET_NAME \
              -c instance_type=$INSTANCE_TYPE \
              -c nat_gateways=$NAT_GATEWAYS \
              --require-approval never

workflows:
  deploy_flow:
    jobs:
      - deploy:
          name: Deploy to Dev
          env_name: "dev"
          filters:
            branches:
              only: main

      - hold-for-approval:
          type: approval
          requires:
            - Deploy to Dev

      - deploy:
          name: Deploy to Prod
          env_name: "prod"
          requires:
            - hold-for-approval
          filters:
            branches:
              only: main