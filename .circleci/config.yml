version: 2.1

orbs:
  aws-cli: circleci/aws-cli@5.1.1
  python: circleci/python@2.1.1

jobs:
  # 🚀 Universal CDK Deploy Job (Python-only)
  deploy:
    docker:
      - image: cimg/python:3.11
    parameters:
      env:
        type: string
        default: "dev"
    steps:
      - checkout

      # 🧰 AWS OIDC role assumption
      - aws-cli/setup:
          role_arn: "arn:aws:iam::056198491146:role/CircleCIInfraRole"
          role_session_name: "circleci-deploy-<< parameters.env >>"
          region: "ap-southeast-1"

      # ⚡ Restore cached Python environment
      - restore_cache:
          keys:
            - v1-cdk-py-{{ checksum "cdk/requirements.txt" }}
            - v1-cdk-py-

      # 🐍 Setup Python & install CDK dependencies (includes CLI)
      - run:
          name: 🐍 Setup Python & install CDK dependencies
          command: |
            cd cdk
            python -m venv .venv
            . .venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt
            cdk --version

      # 💾 Save cache for faster future builds
      - save_cache:
          key: v1-cdk-py-{{ checksum "cdk/requirements.txt" }}
          paths:
            - cdk/.venv

      # 🚀 Deploy CDK stack with dynamic environment
      - run:
          name: 🚀 Deploy CDK stack (<< parameters.env >>)
          command: |
            cd cdk
            . .venv/bin/activate
            cdk bootstrap aws://$AWS_ACCOUNT_ID/$AWS_REGION
            cdk deploy --require-approval never -c env=<< parameters.env >>


workflows:
  deploy_pipeline:
    jobs:
      - deploy:
          name: deploy-dev
          env: dev
      - hold-for-approval:
          type: approval
          requires:
            - deploy-dev
      - deploy:
          name: deploy-prod
          env: prod
          requires:
            - hold-for-approval