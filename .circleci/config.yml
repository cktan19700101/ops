version: 2.1

orbs:
  aws-cli: circleci/aws-cli@5.1.1
  python: circleci/python@2.1.1

jobs:
  # üöÄ Deploy to Dev
  deploy-dev:
    docker:
      - image: cimg/python:3.11-node    # includes Python + npm
    steps:
      - checkout

      # üß∞ AWS OIDC role assumption
      - aws-cli/setup:
          role_arn: "arn:aws:iam::056198491146:role/CircleCIInfraRole"
          role_session_name: "circleci-deploy-dev"
          region: "ap-southeast-1"

      # ‚ö° Cache node_modules containing global CDK CLI
      - restore_cache:
          keys:
            - v1-cdk-cli-{{ checksum "cdk/package.json" }}
            - v1-cdk-cli-

      - run:
          name: üß∞ Install AWS CDK CLI
          command: |
            npm install -g aws-cdk@2
            cdk --version

      - save_cache:
          key: v1-cdk-cli-{{ checksum "cdk/package.json" }}
          paths:
            - ~/.npm

      # üêç Setup Python + venv
      - run:
          name: üêç Setup Python & install CDK dependencies
          command: |
            cd cdk
            python -m venv .venv
            . .venv/bin/activate
            pip install -r requirements.txt

      - run:
          name: üöÄ Deploy CDK stack (dev)
          command: |
            cd cdk
            . .venv/bin/activate
            cdk bootstrap aws://$AWS_ACCOUNT_ID/$AWS_REGION
            cdk deploy --require-approval never -c env=dev


  # üöÄ Deploy to Prod (after approval)
  deploy-prod:
    docker:
      - image: cimg/python:3.11-node
    steps:
      - checkout
      - aws-cli/setup:
          role_arn: "arn:aws:iam::056198491146:role/CircleCIInfraRole"
          role_session_name: "circleci-deploy-prod"
          region: "ap-southeast-1"

      - restore_cache:
          keys:
            - v1-cdk-cli-{{ checksum "cdk/package.json" }}
            - v1-cdk-cli-

      - run:
          name: üß∞ Install AWS CDK CLI
          command: |
            npm install -g aws-cdk@2
            cdk --version

      - run:
          name: üêç Setup Python & install CDK dependencies
          command: |
            cd cdk
            python -m venv .venv
            . .venv/bin/activate
            pip install -r requirements.txt

      - run:
          name: üöÄ Deploy CDK stack (prod)
          command: |
            cd cdk
            . .venv/bin/activate
            cdk bootstrap aws://$AWS_ACCOUNT_ID/$AWS_REGION
            cdk deploy --require-approval never -c env=prod


workflows:
  deploy_pipeline:
    jobs:
      - deploy-dev
      - hold-for-approval:
          type: approval
          requires:
            - deploy-dev
      - deploy-prod:
          requires:
            - hold-for-approval