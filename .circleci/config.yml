version: 2.1

orbs:
  aws-cli: circleci/aws-cli@5.1.1
  python: circleci/python@2.1.1

jobs:
  # 🚀 Deploy to Dev
  deploy-dev:
    docker:
      - image: cimg/python:3.11-node    # includes Python + npm
    steps:
      - checkout

      # 🧰 AWS OIDC role assumption
      - aws-cli/setup:
          role_arn: "arn:aws:iam::056198491146:role/CircleCIInfraRole"
          role_session_name: "circleci-deploy-dev"
          region: "ap-southeast-1"

      # ⚡ Restore cached CDK CLI + npm packages
      - restore_cache:
          keys:
            - v1-cdk-cli

      # 🧰 Install AWS CDK CLI (user space, no root permission)
      - run:
          name: 🧰 Install AWS CDK CLI
          command: |
            mkdir -p ~/.local/bin
            npm install aws-cdk@2 --prefix ~/.local
            export PATH=$PATH:~/.local/bin
            cdk --version

      # 💾 Save cache to speed up next run
      - save_cache:
          key: v1-cdk-cli
          paths:
            - ~/.npm
            - ~/.local/lib/node_modules

      # 🐍 Setup Python + venv
      - run:
          name: 🐍 Setup Python & install CDK dependencies
          command: |
            cd cdk
            python -m venv .venv
            . .venv/bin/activate
            pip install -r requirements.txt

      # 🚀 Deploy Dev Stack
      - run:
          name: 🚀 Deploy CDK stack (dev)
          command: |
            export PATH=$PATH:~/.local/bin
            cd cdk
            . .venv/bin/activate
            cdk bootstrap aws://$AWS_ACCOUNT_ID/$AWS_REGION
            cdk deploy --require-approval never -c env=dev


  # 🚀 Deploy to Prod (after approval)
  deploy-prod:
    docker:
      - image: cimg/python:3.11-node
    steps:
      - checkout

      # 🧰 AWS OIDC role assumption
      - aws-cli/setup:
          role_arn: "arn:aws:iam::056198491146:role/CircleCIInfraRole"
          role_session_name: "circleci-deploy-prod"
          region: "ap-southeast-1"

      # ⚡ Restore cached CDK CLI + npm packages
      - restore_cache:
          keys:
            - v1-cdk-cli

      # 🧰 Install AWS CDK CLI (user space)
      - run:
          name: 🧰 Install AWS CDK CLI
          command: |
            mkdir -p ~/.local/bin
            npm install aws-cdk@2 --prefix ~/.local
            export PATH=$PATH:~/.local/bin
            cdk --version

      # 🐍 Setup Python + venv
      - run:
          name: 🐍 Setup Python & install CDK dependencies
          command: |
            cd cdk
            python -m venv .venv
            . .venv/bin/activate
            pip install -r requirements.txt

      # 🚀 Deploy Prod Stack
      - run:
          name: 🚀 Deploy CDK stack (prod)
          command: |
            export PATH=$PATH:~/.local/bin
            cd cdk
            . .venv/bin/activate
            cdk bootstrap aws://$AWS_ACCOUNT_ID/$AWS_REGION
            cdk deploy --require-approval never -c env=prod


workflows:
  deploy_pipeline:
    jobs:
      - deploy-dev
      - hold-for-approval:
          type: approval
          requires:
            - deploy-dev
      - deploy-prod:
          requires:
            - hold-for-approval