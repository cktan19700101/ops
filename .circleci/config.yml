version: 2.1

orbs:
  python: circleci/python@2.1.1

jobs:
  deploy:
    docker:
      - image: cimg/python:3.11
    parameters:
      env_name:
        type: string
    steps:
      - checkout

      # ‚ö° Cache AWS CLI & CDK to speed up future builds
      - restore_cache:
          keys:
            - awscli-cdk-v1

      - run:
          name: Install AWS CLI and CDK (cached)
          command: |
            # Install AWS CLI if missing
            if ! command -v aws &> /dev/null; then
              echo "Installing AWS CLI..."
              sudo apt-get update -y && sudo apt-get install -y awscli
            else
              echo "AWS CLI already installed"
            fi

            # --- Install Node.js + npm if missing (for CDK CLI) ---
            if ! command -v npm &> /dev/null; then
              echo "Installing Node.js + npm..."
              curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
              sudo apt-get install -y nodejs
            else
              echo "Node.js already installed"
            fi

            # Install AWS CDK globally if missing
            if ! command -v cdk &> /dev/null; then
              echo "Installing AWS CDK globally..."
              sudo npm install -g aws-cdk
            else
              echo "AWS CDK already installed"
            fi

      - save_cache:
          key: awscli-cdk-v1
          paths:
            - /usr/bin/aws
            - /usr/local/lib/node_modules/aws-cdk

      # üß© Assume AWS Role via OIDC
      - run:
          name: Debug CircleCI OIDC Token
          command: |
            echo "üîç Checking CircleCI OIDC Token availability..."
            if [ -z "${CIRCLE_OIDC_TOKEN_FILE}" ]; then
              echo "‚ùå CIRCLE_OIDC_TOKEN_FILE is not set. OIDC may not be enabled for this project."
              exit 1
            fi

            echo "‚úÖ Token file path: $CIRCLE_OIDC_TOKEN_FILE"
            echo "üîë Token file exists? $(test -f "$CIRCLE_OIDC_TOKEN_FILE" && echo yes || echo no)"
            echo ""
            echo "üîì Decoding token header and payload..."

            # Install jq and coreutils for base64 decoding
            sudo apt-get update -y && sudo apt-get install -y jq coreutils

            # Decode header
            head -n1 "$CIRCLE_OIDC_TOKEN_FILE" | cut -d. -f1 | base64 --decode 2>/dev/null || true
            echo ""
            echo "---"

            # Decode payload
            head -n1 "$CIRCLE_OIDC_TOKEN_FILE" | cut -d. -f2 | base64 --decode 2>/dev/null | jq .
            echo ""
            echo "‚úÖ End of OIDC Token Debug"
      - run:
          name: Assume AWS OIDC Role
          command: |
            echo "Assuming role via OIDC..."
            export AWS_ROLE_ARN="arn:aws:iam::${AWS_ACCOUNT_ID}:role/CircleCIInfraRole"
            export AWS_WEB_IDENTITY_TOKEN_FILE="${CIRCLE_OIDC_TOKEN_FILE}"
            export AWS_REGION="${AWS_REGION}"
            aws sts get-caller-identity

      # üêç Python setup for CDK
      - run:
          name: Setup Python & install dependencies
          command: |
            cd cdk
            python -m venv .venv
            . .venv/bin/activate
            pip install -r requirements.txt
            pip install aws-cdk-lib constructs

      # üöÄ Deploy Stack
      - run:
          name: Bootstrap & deploy stack
          command: |
            cd cdk
            . .venv/bin/activate
            cdk bootstrap aws://$AWS_ACCOUNT_ID/$AWS_REGION
            cdk deploy \
              -c env=<< parameters.env_name >> \
              -c main_bucket_name=$MAIN_BUCKET_NAME \
              -c log_bucket_name=$LOG_BUCKET_NAME \
              -c instance_type=$INSTANCE_TYPE \
              -c nat_gateways=$NAT_GATEWAYS \
              --require-approval never

# üß≠ Workflow: Dev ‚Üí Approval ‚Üí Prod
workflows:
  deploy_flow:
    jobs:
      - deploy:
          name: Deploy to Dev
          env_name: "dev"
          filters:
            branches:
              only: main

      - hold-for-approval:
          type: approval
          requires:
            - Deploy to Dev

      - deploy:
          name: Deploy to Prod
          env_name: "prod"
          requires:
            - hold-for-approval
          filters:
            branches:
              only: main
